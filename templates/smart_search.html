{% extends "base.html" %}

{% block title %}Smart Search - Lost & Found{% endblock %}

{% block content %}
<div class="header">
    <h1>üîç Smart Search</h1>
    <p>Use natural language to search for items</p>
</div>

<div class="card">
    <h2>Search with Natural Language</h2>
    <div class="search-container">
        <input type="text" id="searchQuery" placeholder="e.g., 'black iPhone lost in library' or 'red wallet found near cafeteria'" class="search-input">
        <button onclick="performSmartSearch()" class="btn">üîç Smart Search</button>
    </div>
    
    <div class="search-examples">
        <h4>üí° Try these examples:</h4>
        <div class="example-queries">
            <span class="example-query" onclick="setQuery(this.textContent)">blue backpack library</span>
            <span class="example-query" onclick="setQuery(this.textContent)">iPhone charger classroom</span>
            <span class="example-query" onclick="setQuery(this.textContent)">black wallet parking</span>
            <span class="example-query" onclick="setQuery(this.textContent)">keys with red keychain</span>
        </div>
    </div>
</div>

<div class="card">
    <h2>Search Results</h2>
    <div id="searchResults">
        <p class="loading">Enter a search query to find items</p>
    </div>
</div>

<div class="back-button-section">
    <a href="{{ url_for('user_dashboard') }}" class="back-btn">
        ‚Üê Back to Dashboard
    </a>
</div>
{% endblock %}

{% block scripts %}
<style>
.search-container {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.search-input {
    flex: 1;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
}

.search-input:focus {
    border-color: #00bfa5;
    outline: none;
}

.search-examples {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
}

.example-queries {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.example-query {
    background: #e3f2fd;
    color: #1976d2;
    padding: 6px 12px;
    border-radius: 15px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.example-query:hover {
    background: #1976d2;
    color: white;
}

.search-result {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin: 10px 0;
    background: white;
}

.relevance-high { border-left: 4px solid #4caf50; }
.relevance-medium { border-left: 4px solid #ff9800; }
.relevance-low { border-left: 4px solid #f44336; }

.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.relevance-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: bold;
}

.relevance-high .relevance-badge { background: #4caf50; color: white; }
.relevance-medium .relevance-badge { background: #ff9800; color: white; }
.relevance-low .relevance-badge { background: #f44336; color: white; }
</style>

<script>
function setQuery(query) {
    document.getElementById('searchQuery').value = query;
    performSmartSearch();
}

function performSmartSearch() {
    const query = document.getElementById('searchQuery').value.trim();
    const resultsContainer = document.getElementById('searchResults');
    
    if (!query) {
        resultsContainer.innerHTML = '<p class="loading">Please enter a search query</p>';
        return;
    }
    
    resultsContainer.innerHTML = '<p class="loading">üîç Searching with AI...</p>';
    
    fetch('/smart_search', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(results => {
        displaySearchResults(results);
    })
    .catch(error => {
        console.error('Search error:', error);
        resultsContainer.innerHTML = '<p class="loading">Search error occurred</p>';
    });
}

function displaySearchResults(results) {
    const container = document.getElementById('searchResults');
    
    if (results.length === 0) {
        container.innerHTML = '<p class="loading">No matching items found. Try different keywords.</p>';
        return;
    }
    
    let html = `<h3>Found ${results.length} matching items:</h3>`;
    
    results.forEach(result => {
        const report = result.report;
        const relevance = result.relevance.toLowerCase();
        
        html += `
            <div class="search-result relevance-${relevance}">
                <div class="result-header">
                    <h4>${report.item_name}</h4>
                    <span class="relevance-badge">${result.relevance} Match</span>
                </div>
                <p><strong>Type:</strong> ${report.type === 'lost' ? '‚ùå Lost' : '‚úÖ Found'}</p>
                <p><strong>Description:</strong> ${report.description}</p>
                <p><strong>Location:</strong> ${report.location}</p>
                <p><strong>Contact:</strong> ${report.name} (${report.email})</p>
                <p><strong>Date:</strong> ${new Date(report.date_reported).toLocaleDateString()}</p>
                ${report.image_filename ? `<img src="/static/uploads/${report.image_filename}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; margin-top: 10px;" onclick="showImageModal('/static/uploads/${report.image_filename}')">` : ''}
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Allow Enter key to search
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('searchQuery').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            performSmartSearch();
        }
    });
});
</script>
{% endblock %}